# Content-Bot-v3 宝塔面板部署完整指南

## 目录
- [环境准备](#环境准备)
- [宝塔面板安装](#宝塔面板安装)
- [Python 环境配置](#python-环境配置)
- [项目部署](#项目部署)
- [进程守护配置](#进程守护配置)
- [Nginx 反向代理（可选）](#nginx-反向代理可选)
- [SSL 证书配置（可选）](#ssl-证书配置可选)
- [常见问题](#常见问题)

---

## 环境准备

### 1. 服务器要求
- **操作系统**: CentOS 7.x/8.x、Ubuntu 18.04/20.04/22.04、Debian 9/10/11
- **内存**: 建议 2GB 或以上
- **硬盘**: 建议 20GB 或以上
- **Python**: Python 3.8 或以上版本

### 2. 准备工作
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y  # Ubuntu/Debian
# 或
sudo yum update -y  # CentOS

# 安装必要工具
sudo apt install -y wget curl git  # Ubuntu/Debian
# 或
sudo yum install -y wget curl git  # CentOS
```

---

## 宝塔面板安装

### 1. 安装宝塔面板

#### Ubuntu/Debian 系统
```bash
wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

#### CentOS 系统
```bash
yum install -y wget && wget -O install.sh https://download.bt.cn/install/install_6.0.sh && sh install.sh
```

### 2. 登录宝塔面板
安装完成后会显示登录信息：
```
==================================================================
Congratulations! Installed successfully!
==================================================================
Bt-Panel: http://你的服务器IP:8888/xxxxx
username: xxxxxx
password: xxxxxx
==================================================================
```

### 3. 登录并配置
1. 访问宝塔面板地址：`http://你的服务器IP:8888/xxxxx`
2. 输入用户名和密码登录
3. 绑定宝塔账号（可选）
4. 安装推荐软件套件（LNMP 或 LAMP）

---

## Python 环境配置

### 1. 安装 Python 项目管理器

#### 方法一：在宝塔面板中安装（推荐）
1. 登录宝塔面板
2. 点击左侧菜单 **"软件商店"**
3. 搜索 **"Python项目管理器"**
4. 点击 **"安装"**
5. 等待安装完成

#### 方法二：手动安装 Python
```bash
# Ubuntu/Debian
sudo apt install -y python3 python3-pip python3-venv

# CentOS
sudo yum install -y python3 python3-pip

# 验证安装
python3 --version
pip3 --version
```

### 2. 安装 FFmpeg（必需）

#### 在宝塔面板中安装
1. 点击左侧菜单 **"软件商店"**
2. 搜索 **"FFmpeg"**
3. 点击 **"安装"**

#### 或命令行安装
```bash
# Ubuntu/Debian
sudo apt install -y ffmpeg

# CentOS/RHEL
sudo yum install -y epel-release
sudo yum install -y ffmpeg

# 验证安装
ffmpeg -version
```

---

## 项目部署

### 1. 下载项目文件

#### 方法一：通过 Git 克隆（推荐）
```bash
# 在服务器上执行
cd /www/wwwroot
git clone https://github.com/kobex95/Content-Bot-v3.git
cd Content-Bot-v3
```

#### 方法二：通过宝塔面板上传
1. 登录宝塔面板
2. 点击左侧菜单 **"网站"**
3. 选择 **"添加站点"**
4. 域名填写（可选，可以填临时域名）
5. 根目录设置为 `/www/wwwroot/Content-Bot-v3`
6. 创建后进入文件管理
7. 上传项目文件（可以直接拖拽整个文件夹）

### 2. 创建 Python 虚拟环境

#### 通过宝塔面板操作
1. 点击左侧菜单 **"Python项目管理器"**
2. 点击 **"创建"**
3. 填写项目信息：
   - **项目名称**: `content-bot-v3`
   - **项目路径**: `/www/wwwroot/Content-Bot-v3`
   - **Python版本**: 选择 Python 3.11 或更高
   - **启动文件**: `main.py`
4. 点击 **"提交"**

#### 或命令行操作
```bash
cd /www/wwwroot/Content-Bot-v3

# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate

# 升级 pip
pip install --upgrade pip
```

### 3. 安装项目依赖

#### 通过宝塔面板操作
1. 在 **"Python项目管理器"** 中找到项目
2. 点击 **"设置"**
3. 点击 **"模块"** 标签
4. 在 **"安装模块"** 输入框中输入：
   ```
   -r requirements.txt
   ```
5. 点击 **"安装"**

#### 或命令行操作
```bash
cd /www/wwwroot/Content-Bot-v3
source venv/bin/activate
pip install -r requirements.txt
```

### 4. 配置环境变量

#### 方法一：创建 .env 文件（推荐）
```bash
cd /www/wwwroot/Content-Bot-v3

# 复制示例文件
cp .env.example .env

# 编辑 .env 文件
nano .env
```

.env 文件内容：
```env
# Telegram API 配置
API_ID=12345678
API_HASH=your_api_hash_here
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# 用户配置
OWNER_ID=123456789
CHANNEL_ID=-1001234567890
LOG_GROUP=-1001234567890

# 数据库配置
MONGO_DB=mongodb+srv://user:pass@cluster.mongodb.net/bot

# 可选配置
STRING=
FREEMIUM_LIMIT=0
PREMIUM_LIMIT=500
YT_COOKIES=
INSTA_COOKIES=
WEBSITE_URL=
AD_API=

# 加密配置
MASTER_KEY=gK8HzLfT9QpViJcYeB5wRa3DmN7P2xUq
IV_KEY=s7Yx5CpVmE3F
```

#### 方法二：通过宝塔面板配置
1. 在 **"Python项目管理器"** 中找到项目
2. 点击 **"设置"**
3. 点击 **"环境变量"** 标签
4. 添加以下环境变量：
   ```
   API_ID=12345678
   API_HASH=your_api_hash_here
   BOT_TOKEN=your_bot_token_here
   OWNER_ID=your_owner_id
   CHANNEL_ID=your_channel_id
   LOG_GROUP=your_log_group
   MONGO_DB=your_mongo_url
   MASTER_KEY=your_master_key
   IV_KEY=your_iv_key
   ```

### 5. 创建必要目录
```bash
cd /www/wwwroot/Content-Bot-v3

# 创建会话目录
mkdir -p sessions
mkdir -p downloads

# 设置权限
chmod 755 sessions
chmod 755 downloads
```

---

## 进程守护配置

### 方法一：使用宝塔 Python 项目管理器（推荐）

#### 1. 配置项目启动
1. 在 **"Python项目管理器"** 中找到项目
2. 点击 **"设置"**
3. 点击 **"配置"** 标签
4. 确认以下配置：
   - **启动文件**: `main.py`
   - **端口**: 如果有 Web 服务填写，否则留空
   - **启动方式**: 选择 **"守护进程"**
5. 点击 **"保存"**

#### 2. 启动项目
1. 点击项目右侧的 **"启动"** 按钮
2. 查看日志输出，确认无错误

#### 3. 设置开机自启
1. 在项目设置中，点击 **"开机自启"** 标签
2. 点击 **"设置"**
3. 勾选 **"启用"**
4. 点击 **"保存"**

### 方法二：使用 Supervisor（传统方式）

#### 1. 安装 Supervisor
```bash
# Ubuntu/Debian
sudo apt install -y supervisor

# CentOS
sudo yum install -y supervisor

# 启动 Supervisor
sudo systemctl start supervisor
sudo systemctl enable supervisor
```

#### 2. 创建配置文件
```bash
sudo nano /etc/supervisor/conf.d/content-bot.conf
```

配置文件内容：
```ini
[program:content-bot]
command=/www/wwwroot/Content-Bot-v3/venv/bin/python /www/wwwroot/Content-Bot-v3/main.py
directory=/www/wwwroot/Content-Bot-v3
user=www
autostart=true
autorestart=true
startretries=3
startsecs=5
redirect_stderr=true
stdout_logfile=/www/wwwroot/Content-Bot-v3/logs/bot.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
environment=
    API_ID="your_api_id",
    API_HASH="your_api_hash",
    BOT_TOKEN="your_bot_token",
    OWNER_ID="your_owner_id",
    CHANNEL_ID="your_channel_id",
    LOG_GROUP="your_log_group",
    MONGO_DB="your_mongo_url",
    MASTER_KEY="your_master_key",
    IV_KEY="your_iv_key"
```

#### 3. 创建日志目录
```bash
mkdir -p /www/wwwroot/Content-Bot-v3/logs
chmod 755 /www/wwwroot/Content-Bot-v3/logs
```

#### 4. 加载并启动
```bash
# 重新加载配置
sudo supervisorctl reread
sudo supervisorctl update

# 启动服务
sudo supervisorctl start content-bot

# 查看状态
sudo supervisorctl status

# 查看日志
sudo supervisorctl tail -f content-bot
```

### 方法三：使用 Systemd

#### 1. 创建服务文件
```bash
sudo nano /etc/systemd/system/content-bot.service
```

服务文件内容：
```ini
[Unit]
Description=Content Bot v3
After=network.target

[Service]
Type=simple
User=www
WorkingDirectory=/www/wwwroot/Content-Bot-v3
Environment="PATH=/www/wwwroot/Content-Bot-v3/venv/bin"
ExecStart=/www/wwwroot/Content-Bot-v3/venv/bin/python /www/wwwroot/Content-Bot-v3/main.py
Restart=always
RestartSec=10

Environment="API_ID=your_api_id"
Environment="API_HASH=your_api_hash"
Environment="BOT_TOKEN=your_bot_token"
Environment="OWNER_ID=your_owner_id"
Environment="CHANNEL_ID=your_channel_id"
Environment="LOG_GROUP=your_log_group"
Environment="MONGO_DB=your_mongo_url"
Environment="MASTER_KEY=your_master_key"
Environment="IV_KEY=your_iv_key"

[Install]
WantedBy=multi-user.target
```

#### 2. 启动服务
```bash
# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start content-bot

# 设置开机自启
sudo systemctl enable content-bot

# 查看状态
sudo systemctl status content-bot

# 查看日志
sudo journalctl -u content-bot -f
```

---

## Nginx 反向代理（可选）

如果您的项目包含 Web 服务（app.py），可以配置 Nginx 反向代理。

### 1. 在宝塔面板中配置

#### 方法一：通过宝塔面板添加站点
1. 点击左侧菜单 **"网站"**
2. 点击 **"添加站点"**
3. 填写域名（可选）
4. 根目录设置为 `/www/wwwroot/Content-Bot-v3`
5. PHP 版本选择 **"纯静态"**
6. 点击 **"提交"**

#### 方法二：配置反向代理
1. 在网站列表中找到刚创建的站点
2. 点击 **"设置"**
3. 点击 **"反向代理"** 标签
4. 点击 **"添加反向代理"**
5. 填写配置：
   - **代理名称**: `ContentBot`
   - **目标URL**: `http://127.0.0.1:5000`（假设 Flask 运行在 5000 端口）
   - **发送域名**: `$host`
6. 点击 **"提交"**

### 2. 手动配置 Nginx

```bash
# 编辑 Nginx 配置文件
sudo nano /www/server/panel/vhost/nginx/content-bot.conf
```

配置文件内容：
```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # 静态文件缓存
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
```

### 3. 重载 Nginx
```bash
# 在宝塔面板中点击 Nginx 服务 -> 重载配置

# 或命令行操作
sudo nginx -t
sudo systemctl reload nginx
```

---

## SSL 证书配置（可选）

### 1. 在宝塔面板中申请 SSL

#### 免费证书（Let's Encrypt）
1. 点击网站 **"设置"**
2. 点击 **"SSL"** 标签
3. 选择 **"Let's Encrypt"**
4. 填写域名和邮箱
5. 点击 **"申请"**

#### 手动证书
1. 点击网站 **"设置"**
2. 点击 **"SSL"** 标签
3. 选择 **"其他证书"**
4. 粘贴证书内容和密钥
5. 点击 **"保存"**

### 2. 强制 HTTPS
1. 在 SSL 设置中
2. 勾选 **"强制 HTTPS"**
3. 点击 **"保存"**

---

## 常见问题

### 1. 依赖安装失败

#### 问题：pip 安装速度慢或失败
```bash
# 使用国内镜像源
pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple

# 或永久配置镜像源
pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple
```

#### 问题：某些依赖包安装失败
```bash
# 安装系统依赖
sudo apt install -y build-essential python3-dev  # Ubuntu/Debian
sudo yum install -y python3-devel gcc  # CentOS

# 重新安装依赖
pip install -r requirements.txt
```

### 2. 服务无法启动

#### 问题：端口被占用
```bash
# 查看端口占用
sudo netstat -tlnp | grep 5000
# 或
sudo lsof -i :5000

# 杀死占用端口的进程
sudo kill -9 <PID>
```

#### 问题：权限不足
```bash
# 检查文件权限
ls -la /www/wwwroot/Content-Bot-v3

# 修改文件所有者
sudo chown -R www:www /www/wwwroot/Content-Bot-v3

# 修改文件权限
sudo chmod -R 755 /www/wwwroot/Content-Bot-v3
```

### 3. 日志查看

#### 方法一：宝塔面板查看
1. 点击 **"Python项目管理器"**
2. 找到项目，点击 **"日志"**

#### 方法二：命令行查看
```bash
# Supervisor
sudo supervisorctl tail -f content-bot

# Systemd
sudo journalctl -u content-bot -f

# 直接查看日志文件
tail -f /www/wwwroot/Content-Bot-v3/logs/bot.log
```

### 4. 内存不足

#### 问题：服务频繁重启
```bash
# 增加虚拟内存（swap）
sudo dd if=/dev/zero of=/swapfile bs=1M count=2048
sudo chmod 600 /swapfile
sudo mkswap /swapfile
sudo swapon /swapfile

# 永久启用 swap
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

### 5. 更新项目

#### 方法一：使用 Git
```bash
cd /www/wwwroot/Content-Bot-v3
git pull

# 更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 重启服务
sudo supervisorctl restart content-bot
```

#### 方法二：通过宝塔面板
1. 进入文件管理
2. 上传新版本文件覆盖旧文件
3. 在 Python 项目管理器中重启项目

---

## 防火墙配置

### 1. 在宝塔面板中配置

1. 点击左侧菜单 **"安全"**
2. 添加放行端口（如果需要）
   - **端口**: `5000`（Web 服务）
   - **协议**: TCP
   - **说明**: Content Bot Web
3. 点击 **"提交"**

### 2. 命令行配置

#### UFW (Ubuntu)
```bash
sudo ufw allow 5000/tcp
sudo ufw reload
sudo ufw status
```

#### firewalld (CentOS)
```bash
sudo firewall-cmd --permanent --add-port=5000/tcp
sudo firewall-cmd --reload
sudo firewall-cmd --list-ports
```

---

## 监控和维护

### 1. 宝塔面板监控
- 在面板首页可以看到服务器资源使用情况
- CPU、内存、磁盘、网络实时监控

### 2. 定时任务（备份）
1. 点击左侧菜单 **"计划任务"**
2. 点击 **"添加任务"**
3. 配置：
   - **任务类型**: 备份网站
   - **执行周期**: 每天
   - **保留份数**: 7
   - **备份目录**: `/www/wwwroot/Content-Bot-v3`

### 3. 日志清理
1. 点击左侧菜单 **"日志"**
2. 配置日志清理规则
3. 设置日志保留天数

---

## 性能优化

### 1. 数据库优化
如果使用 MongoDB，考虑：
- 使用 MongoDB 连接池
- 添加索引
- 定期清理过期数据

### 2. 缓存优化
如果使用 Redis：
```bash
# 安装 Redis
sudo apt install -y redis-server

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 3. 文件清理
定期清理临时文件：
```bash
# 清理会话文件
find /www/wwwroot/Content-Bot-v3/sessions -name "*.session" -mtime +7 -delete

# 清理下载文件
find /www/wwwroot/Content-Bot-v3/downloads -type f -mtime +7 -delete
```

---

## 总结

### 快速部署流程

1. **安装宝塔面板**
   ```bash
   wget -O install.sh https://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
   ```

2. **安装 Python 项目管理器**
   - 在软件商店中搜索并安装

3. **下载项目**
   ```bash
   cd /www/wwwroot
   git clone https://github.com/kobex95/Content-Bot-v3.git
   ```

4. **配置环境变量**
   - 创建 `.env` 文件
   - 填写必要的配置信息

5. **安装依赖**
   ```bash
   cd Content-Bot-v3
   python3 -m venv venv
   source venv/bin/activate
   pip install -r requirements.txt
   ```

6. **启动项目**
   - 使用 Python 项目管理器启动
   - 设置开机自启

### 有用命令速查

```bash
# 查看服务状态
sudo supervisorctl status content-bot

# 重启服务
sudo supervisorctl restart content-bot

# 查看日志
sudo supervisorctl tail -f content-bot

# 停止服务
sudo supervisorctl stop content-bot

# 更新项目
cd /www/wwwroot/Content-Bot-v3
git pull
sudo supervisorctl restart content-bot
```

### 宝塔面板常用操作

| 操作 | 位置 |
|------|------|
| 安装软件 | 软件商店 |
| 文件管理 | 文件 |
| 服务管理 | 软件商店 -> 已安装 |
| 日志查看 | 日志 |
| 计划任务 | 计划任务 |
| 防火墙设置 | 安全 |
| SSL 证书 | 网站设置 -> SSL |
| 反向代理 | 网站设置 -> 反向代理 |

---

**文档版本**: 1.0
**最后更新**: 2026年1月8日
**适用版本**: Content-Bot-v3
**适用面板**: 宝塔面板 7.x
